<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Adressen nach Entfernung sortieren</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      direction: ltr;
      text-align: center;
      margin: 20px;
      background: #f7f7f7;
    }
    h2 {
      color: #333;
    }
    input, button {
      padding: 10px;
      margin: 5px;
      border-radius: 8px;
      border: 1px solid #ccc;
    }
    button {
      cursor: pointer;
      background: #4CAF50;
      color: white;
      border: none;
    }





    
    tr:hover {
  background: #d3ffd3 !important;
  cursor: pointer;
}





    table {
      width: 90%;
      margin: 20px auto;
      border-collapse: collapse;
      background: white;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    th, td {
      padding: 12px;
      border: 1px solid #ddd;
    }
    th {
      background: #4CAF50;
      color: white;
    }
    ul {
      list-style: none;
      padding: 0;
    }
    li {
      background: #fff;
      margin: 5px auto;
      padding: 8px;
      width: 70%;
      border-radius: 6px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.1);
    }
    #reportPreview {
      display: block;
      background: url("images/-heilbronn-startseite-uebersicht-1.webp") no-repeat center center;
      background-size: contain;
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      max-width: 850px;
      margin: auto;
      min-height: 1123px;
  }
  </style>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

</head>
<body>
    <div class="image-box">
        <a href="https://www.adragna-wohndesign.de/#raum-umgebung.html" target="_blank">
          <img src="images/heilbronn-fliesenleger-fliesenreinigung-logo.jpeg" alt="Mein Logo"/>
        </a>

        <a href="https://www.adragna-wohndesign.de/#raum-umgebung.html" target="_blank">
          <img src="images/heilbronn-fliesenleger-fliesenreinigung-logo-text.jpeg" alt="Mein Logo"/>
        </a>

  </div>

  <h2 >Adressen <b style="color: black;">von</b> der nÃ¤chsten <b style="color: black;">bis</b> zur weitesten Entfernung</h2>

  <div>
    <input type="text" id="streetInput" placeholder="StraÃŸe und Hausnummer">
    <input type="text" id="zipInput" placeholder="Postleitzahl">
    <button onclick="addAddress()">Adresse hinzufÃ¼gen</button>
    <button onclick="processAddresses()">Sortierung anzeigen</button>
  </div>

  <ul id="addressList"></ul>

  <table id="resultTable" style="display:none;">
    <thead>
      <tr>
        <th>Adresse</th>
        <th>Stadt</th>
        <th>Entfernung vom Nutzer (km)</th>
        <th>Entfernung von vorheriger Adresse (km)</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>


 <div id="map" style="height: 500px; width: 90%; margin: 20px auto; border-radius: 12px; overflow: hidden;"></div>
  


  <div id="reportPreview"></div>

  <script>
    let userLocation = null;
    let addresses = [];

    // Standort automatisch vom Browser holen
    navigator.geolocation.getCurrentPosition(pos => {
      userLocation = {
        lat: pos.coords.latitude,
        lon: pos.coords.longitude
      };
    }, err => {
      alert("Bitte aktiviere den Standort (GPS) im Browser.");
    });

    // Adresse hinzufÃ¼gen
    async function addAddress() {
      const street = document.getElementById("streetInput").value.trim();
      const zip = document.getElementById("zipInput").value.trim();

      if (street && zip) {
        const fullAddress = `${street}, ${zip}, Germany`;
        const coords = await geocodeAddress(fullAddress);
        if (coords) {
          const confirmMsg = `Meintest du diese Adresse?\n${coords.display_name}`;
          if (confirm(confirmMsg)) {
            addresses.push(coords);
            const li = document.createElement("li");
            li.textContent = coords.display_name;
            document.getElementById("addressList").appendChild(li);
          } else {
            alert("Bitte korrigiere die Adresse und versuche erneut.");
          }
        }
        document.getElementById("streetInput").value = "";
        document.getElementById("zipInput").value = "";
      } else {
        alert("Bitte StraÃŸe + Hausnummer und Postleitzahl eingeben.");
      }
    }

    // Adressen sortieren und Tabelle anzeigen
    async function processAddresses() {
      if (!userLocation) {
        alert("Dein Standort ist noch nicht bestimmt.");
        return;
      }
      if (addresses.length === 0) {
        alert("Bitte mindestens eine Adresse eingeben.");
        return;
      }

      let results = addresses.map(addr => ({
        address: addr.display_name,
        city: addr.city || addr.town || addr.village || "Unbekannt",
        distance: parseFloat(haversine(userLocation.lat, userLocation.lon, addr.lat, addr.lon))
      }));

      results.sort((a, b) => a.distance - b.distance);

      displayResults(results);
    }
        // Ø¹Ø±Ø¶ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø¨Ø¹Ø¯ Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
showMap(results);

function showMap(results) {
  if (!userLocation) return;

  const map = L.map("map").setView([userLocation.lat, userLocation.lon], 11);

  // Ø·Ø¨Ù‚Ø© Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  // Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
  const userMarker = L.marker([userLocation.lat, userLocation.lon]).addTo(map);
  userMarker.bindPopup("ğŸ“ Ù…ÙˆÙ‚Ø¹Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ").openPopup();

  // Ø¹Ù†Ø§ÙˆÙŠÙ† Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„
  results.forEach((res, i) => {
    const marker = L.marker([addresses[i].lat, addresses[i].lon]).addTo(map);
    marker.bindPopup(`${res.address}<br>ğŸ“ ${res.distance.toFixed(2)} km`);
  });
}

    // Nominatim API fÃ¼r Geocoding
    async function geocodeAddress(address) {
      const url = `https://nominatim.openstreetmap.org/search?format=json&addressdetails=1&q=${encodeURIComponent(address)}`;
      try {
        const response = await fetch(url);
        const data = await response.json();
        if (data && data.length > 0) {
          const item = data[0];
          return {
            lat: parseFloat(item.lat),
            lon: parseFloat(item.lon),
            display_name: item.display_name,
            city: item.address.city || item.address.town || item.address.village
          };
        } else {
          alert("Adresse nicht gefunden: " + address);
          return null;
        }
      } catch (err) {
        alert("Fehler beim Abrufen der Adresse: " + address);
        return null;
      }
    }

    // Haversine Formel fÃ¼r Entfernungen
    function haversine(lat1, lon1, lat2, lon2) {
      const R = 6371;
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLon = (lon2 - lon1) * Math.PI / 180;
      const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c;
    }

    // Ergebnisse in Tabelle anzeigen
    function displayResults(results) {
  const table = document.getElementById("resultTable");
  const tbody = table.querySelector("tbody");
  tbody.innerHTML = "";

  const maxDistance = Math.max(...results.map(r => r.distance));

  for (let i = 0; i < results.length; i++) {
    const res = results[i];
    const prevDistance = i === 0 ? '-' : (results[i].distance - results[i - 1].distance).toFixed(2);

    const row = document.createElement("tr");

    // Ù„ÙˆÙ† Ø§Ù„ØµÙ Ø­Ø³Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ© (Ø£Ø®Ø¶Ø± Ù‚Ø±ÙŠØ¨ - Ø£Ø­Ù…Ø± Ø¨Ø¹ÙŠØ¯)
    const ratio = res.distance / maxDistance;
    const red = Math.floor(255 * ratio);
    const green = Math.floor(255 * (1 - ratio));
    row.style.backgroundColor = `rgb(${red},${green},0)`;

    row.innerHTML = `
      <td>${res.address}</td>
      <td>${res.city}</td>
      <td>${res.distance.toFixed(2)}</td>
      <td>${prevDistance}</td>
    `;

    // ğŸŸ¢ Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„ØµÙØŒ Ø§ÙØªØ­ Ø§Ù„Ø®Ø±ÙŠØ·Ø© ÙˆØ§Ù†Ø³Ø® Ø§Ù„Ø¹Ù†ÙˆØ§Ù†
    row.addEventListener("click", () => {
      const url = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(res.address)}`;
      window.open(url, "_blank");

      navigator.clipboard.writeText(res.address).then(() => {
        alert("ğŸ“ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† ØªÙ… Ù†Ø³Ø®Ù‡! ÙŠÙ…ÙƒÙ†Ùƒ Ù„ØµÙ‚Ù‡ Ù…Ø¨Ø§Ø´Ø±Ø©.");
      });
    });

    tbody.appendChild(row);
  }

  table.style.display = "table";

  // Ø¹Ø±Ø¶ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø¨Ø¹Ø¯ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
  showMap(results);
}

  </script>
</body>
</html>
